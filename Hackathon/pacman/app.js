const layout = [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 3, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 3, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 1, 1, 1, 2, 2, 1, 1, 1, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 1, 2, 2, 2, 2, 2, 2, 1, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 4, 4, 4, 4, 4, 4, 0, 0, 0, 4, 1, 2, 2, 2, 2, 2, 2, 1, 4, 0, 0, 0, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 1, 2, 2, 2, 2, 2, 2, 1, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 4, 1, 1, 1, 1, 1, 1, 1, 1, 4, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 3, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 3, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,];
// 0 - pac-dots
// 1 - wall
// 2 - ghost-lair
// 3 - power-pellet
// 4 - empty
let utils = ['pac-dots', 'wall', 'ghost-lair', 'power-pellet', 'empty'];
/* 
    * 28 rows 28 columns (560, 560)px
    * top right pos is (0, 0) px
    * each cell takes (20, 20) px
    * we have our coordinate system each div has x, y property
    * pacman spawn location (390, 380) (13, 17)
*/
let pacmanPosX = 13;
let pacmanPosY = 17;
let velocityX = 0, velocityY = 0;
let gameRunning = false;
let score = 0;
let powerPellet = false;

function createBoard() {
    let x = 0, y = 0;
    for (let i = 0; i < layout.length; ++i) {
        let div = document.createElement('div');
        div.classList.add(`${utils[layout[i]]}`);
        div.setAttribute("x", x);
        div.setAttribute("y", y);
        document.querySelector('.grid').append(div);
        ++x;
        if (x == 28)
            x = 0, ++y;
    }
    // add pacman class to {13, 17} cell
    // .grid div[x='13'][y='17']
    let pacmanCell = document.querySelector('.grid div[x="13"][y="17"]');
    pacmanCell.classList.add('pac-man');
    pacmanCell.classList.remove('empty');
    gameRunning = true;
};

/*
    * function to set direction of pacman according to keypress and enemies / obstacles
    * We use 2 variables velocityX, velocityY to track direction
    * 1 -> right / down
    * -1 -> left / up
*/
function setDirection(e) {
    console.log(e.keyCode);
    velocityX = 0, velocityY = 0;
    switch (e.keyCode) {
        // left
        case 37:
            // check for wall
            if (pacmanPosX != 0) {
                let leftCell = document.querySelector(`.grid div[x="${pacmanPosX - 1}"][y="${pacmanPosY}"]`);
                if (!leftCell.classList.contains('ghost-lair') && !leftCell.classList.contains('wall')) {
                    velocityX = -1;
                }
            }
            break;
        // top
        case 38:
            // check for wall
            if (pacmanPosY != 1) {
                let topCell = document.querySelector(`.grid div[x="${pacmanPosX}"][y="${pacmanPosY - 1}"]`);
                if (!topCell.classList.contains('ghost-lair') && !topCell.classList.contains('wall'))
                    velocityY = -1;
            }
            break;
        // right
        case 39:
            if (pacmanPosX != 27) {
                let rightCell = document.querySelector(`.grid div[x="${pacmanPosX + 1}"][y="${pacmanPosY}"]`);
                if (!rightCell.classList.contains('ghost-lair') && !rightCell.classList.contains('wall'))
                    velocityX = 1;
            }
            break;
        // down
        case 40:
            if (pacmanPosY != 26) {
                let bottomCell = document.querySelector(`.grid div[x="${pacmanPosX}"][y="${pacmanPosY + 1}"]`);
                if (!bottomCell.classList.contains('ghost-lair') && !bottomCell.classList.contains('wall'))
                    velocityY = 1;
            }
            break;
    }
    console.log(pacmanPosX + ' ' + pacmanPosY + " : " + velocityX + ' ' + velocityY);
}

function movePacman() {
    setInterval(() => {
        if (velocityX !== 0 || velocityY !== 0) {
            /// todo : check if movement possible
            let currentCell = document.querySelector(`.grid div[x="${pacmanPosX}"][y="${pacmanPosY}"]`);
            currentCell.classList.remove('pac-man');
            if (currentCell.classList.contains('blinking'))
                currentCell.classList.remove('blinking');
            currentCell.classList.add('empty');
            let nextCell = document.querySelector(`.grid div[x="${pacmanPosX + velocityX}"][y="${pacmanPosY + velocityY}"]`);
            if (nextCell.classList.contains('pac-dots')) {
                nextCell.classList.remove('pac-dots');
                ++score;
                let scoreTag = document.querySelector('.game-container h2 .score');
                scoreTag.textContent = score;
                nextCell.classList.add('pac-man');
                if (powerPellet === true)
                    nextCell.classList.add('blinking');
                if (score === 234) {
                    // end game
                    velocityX = 0;
                    velocityY = 0;
                    // remove event
                    document.removeEventListener('keyup', setDirection);
                    console.log('you won');
                }
                pacmanPosX = pacmanPosX + velocityX;
                pacmanPosY = pacmanPosY + velocityY;
            } else if (nextCell.classList.contains('empty')) {
                nextCell.classList.remove('empty');
                nextCell.classList.add('pac-man');
                if (powerPellet === true)
                    nextCell.classList.add('blinking');
                pacmanPosX = pacmanPosX + velocityX;
                pacmanPosY = pacmanPosY + velocityY;
            } else if (nextCell.classList.contains('wall')) {
                currentCell.classList.add('pac-man');
            } else if (nextCell.classList.contains('power-pellet')) {
                /// todo: add power
                powerPellet = true;
                nextCell.classList.remove('power-pellet');
                nextCell.classList.add('pac-man');
                if (powerPellet === true)
                    nextCell.classList.add('blinking');
                nextCell.classList.add('blinking');
                // change ghost colors
                pacmanPosX = pacmanPosX + velocityX;
                pacmanPosY = pacmanPosY + velocityY;
            }
            /// todo: check for pac-dot or ghost or empty...
        } else {
            console.log('stuck at ' + pacmanPosX + ', ' + pacmanPosY);
        }
    }, 200);
}
// document.addEventListener('click', function (e) {
//     console.log(e.clientX + ', ' + e.clientY);
// });

/*
    * create board
    * set direction
    * move Pacman
    * move ghosts
        ** check for power-pallet
        ** check for gameover
*/
(function startGame() {
    createBoard();
    document.addEventListener('keyup', setDirection);
    movePacman();
})();